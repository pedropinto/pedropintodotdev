---
import { getArticlesPageUrl, toTagSlug } from "../lib/articles";

interface Props {
  tags: string[];
  activeTagSlug?: string;
  visibleTagLimit?: number;
}

const { tags, activeTagSlug, visibleTagLimit = 8 } = Astro.props;
const primaryTags = tags.slice(0, visibleTagLimit);
const overflowTags = tags.slice(visibleTagLimit);
const hasOverflow = overflowTags.length > 0;
const activeInOverflow = hasOverflow
  ? overflowTags.some((tag) => toTagSlug(tag) === activeTagSlug)
  : false;
---

{tags.length > 0 && (
  <section class="mt-7">
    <h2 class="sr-only">Filter by tag</h2>
    <div class="flex flex-wrap items-center gap-2" id="tag-filters">
      <a
        href={getArticlesPageUrl(1)}
        class:list={[
          "tag-filter rounded-full border border-[var(--color-text)]/20 bg-[var(--color-white)] px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-text)] transition-colors duration-200",
          !activeTagSlug && "is-active",
        ]}
        aria-current={!activeTagSlug ? "page" : undefined}
      >
        All
      </a>

      {primaryTags.map((tag) => {
        const slug = toTagSlug(tag);
        return (
          <a
            href={getArticlesPageUrl(1, slug)}
            class:list={[
              "tag-filter rounded-full border border-[var(--color-text)]/20 bg-[var(--color-white)] px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-text)] transition-colors duration-200",
              activeTagSlug === slug && "is-active",
            ]}
            aria-current={activeTagSlug === slug ? "page" : undefined}
          >
            {tag}
          </a>
        );
      })}

      {hasOverflow && (
        <>
          <div class:list={["hidden flex-wrap gap-2", activeInOverflow && "flex"]} id="overflow-tags">
            {overflowTags.map((tag) => {
              const slug = toTagSlug(tag);
              return (
                <a
                  href={getArticlesPageUrl(1, slug)}
                  class:list={[
                    "tag-filter rounded-full border border-[var(--color-text)]/20 bg-[var(--color-white)] px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-text)] transition-colors duration-200",
                    activeTagSlug === slug && "is-active",
                  ]}
                  aria-current={activeTagSlug === slug ? "page" : undefined}
                >
                  {tag}
                </a>
              );
            })}
          </div>

          <button
            id="toggle-tags"
            type="button"
            class="rounded-full border border-[var(--color-text)]/20 bg-transparent px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-muted)] transition-colors duration-200 hover:text-[var(--color-text)]"
            aria-expanded={activeInOverflow ? "true" : "false"}
          >
            {activeInOverflow ? "Less tags" : "More tags"}
          </button>
        </>
      )}
    </div>
  </section>
)}

{
  hasOverflow && (
    <script>
      const overflowTags = document.getElementById("overflow-tags");
      const toggleTagsButton = document.getElementById("toggle-tags");

      if (overflowTags && toggleTagsButton) {
        toggleTagsButton.addEventListener("click", () => {
          const expanded = toggleTagsButton.getAttribute("aria-expanded") === "true";
          if (expanded) {
            overflowTags.classList.add("hidden");
            overflowTags.classList.remove("flex");
            toggleTagsButton.setAttribute("aria-expanded", "false");
            toggleTagsButton.textContent = "More tags";
            return;
          }

          overflowTags.classList.remove("hidden");
          overflowTags.classList.add("flex");
          toggleTagsButton.setAttribute("aria-expanded", "true");
          toggleTagsButton.textContent = "Less tags";
        });
      }
    </script>
  )
}
