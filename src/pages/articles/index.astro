---
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArticleListItem from "../../components/ArticleListItem.astro";
import { getVisibleArticles } from "../../lib/articles";

const articles = await getVisibleArticles();
const tagCounts = new Map<string, number>();
for (const article of articles) {
  for (const rawTag of article.data.tags) {
    const tag = rawTag.trim();
    if (!tag) continue;
    tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
  }
}

const allTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1];
    return a[0].localeCompare(b[0]);
  })
  .map(([tag]) => tag);

const visibleTagLimit = 8;
const primaryTags = allTags.slice(0, visibleTagLimit);
const overflowTags = allTags.slice(visibleTagLimit);
---

<BaseLayout title="Articles | Pedro Pinto" description="Articles on engineering, leadership, and software development.">
  <section class="max-w-3xl">
    <h1 class="font-heading text-4xl text-[var(--color-text)]">Articles</h1>
    <p class="mt-3 text-[var(--color-muted)]">Notes on engineering, leadership, and software.</p>
  </section>

  {articles.length > 0 && allTags.length > 0 && (
    <section class="mt-7">
      <h2 class="sr-only">Filter by tag</h2>
      <div class="flex flex-wrap items-center gap-2" id="tag-filters">
        <button
          type="button"
          class="tag-filter rounded-full border border-[var(--color-text)]/20 bg-[var(--color-white)] px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-text)] transition-colors duration-200"
          data-filter="all"
          aria-pressed="true"
        >
          All
        </button>
        {primaryTags.map((tag) => (
          <button
            type="button"
            class="tag-filter rounded-full border border-[var(--color-text)]/20 bg-[var(--color-white)] px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-text)] transition-colors duration-200"
            data-filter={tag.toLowerCase()}
            aria-pressed="false"
          >
            {tag}
          </button>
        ))}
        {overflowTags.length > 0 && (
          <>
            <div class="hidden flex-wrap gap-2" id="overflow-tags">
              {overflowTags.map((tag) => (
                <button
                  type="button"
                  class="tag-filter rounded-full border border-[var(--color-text)]/20 bg-[var(--color-white)] px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-text)] transition-colors duration-200"
                  data-filter={tag.toLowerCase()}
                  aria-pressed="false"
                >
                  {tag}
                </button>
              ))}
            </div>
            <button
              id="toggle-tags"
              type="button"
              class="rounded-full border border-[var(--color-text)]/20 bg-transparent px-3 py-1.5 text-xs uppercase tracking-[0.08em] text-[var(--color-muted)] transition-colors duration-200 hover:text-[var(--color-text)]"
              aria-expanded="false"
            >
              More tags
            </button>
          </>
        )}
      </div>
    </section>
  )}

  <section class="mt-8 grid gap-4" id="articles-list">
    {articles.length === 0 ? (
      <p class="text-[var(--color-muted)]">No published articles yet.</p>
    ) : (
      articles.map((article) => (
        <div class="article-filter-item" data-tags={article.data.tags.map((tag) => tag.toLowerCase()).join(",")}>
          <ArticleListItem article={article} />
        </div>
      ))
    )}
    <p id="filter-empty" class="hidden text-[var(--color-muted)]">No articles found for this tag yet.</p>
  </section>

  <script>
    const filters = Array.from(document.querySelectorAll(".tag-filter"));
    const items = Array.from(document.querySelectorAll(".article-filter-item"));
    const emptyState = document.getElementById("filter-empty");
    const overflowTags = document.getElementById("overflow-tags");
    const toggleTagsButton = document.getElementById("toggle-tags");

    const setButtonState = (activeFilter) => {
      filters.forEach((button) => {
        const isActive = button.dataset.filter === activeFilter;
        button.setAttribute("aria-pressed", isActive ? "true" : "false");
        button.classList.toggle("is-active", isActive);
      });
    };

    const applyFilter = (filter) => {
      let visibleCount = 0;

      items.forEach((item) => {
        const tags = (item.dataset.tags || "")
          .split(",")
          .map((tag) => tag.trim())
          .filter(Boolean);
        const visible = filter === "all" || tags.includes(filter);
        item.classList.toggle("hidden", !visible);
        if (visible) visibleCount += 1;
      });

      if (emptyState) emptyState.classList.toggle("hidden", visibleCount > 0);
      setButtonState(filter);

      const url = new URL(window.location.href);
      if (filter === "all") {
        url.searchParams.delete("tag");
      } else {
        url.searchParams.set("tag", filter);
      }
      window.history.replaceState({}, "", url.toString());
    };

    const fromQuery = new URLSearchParams(window.location.search).get("tag")?.toLowerCase() || "all";
    const validFilters = new Set(filters.map((button) => button.dataset.filter || "all"));
    const initialFilter = validFilters.has(fromQuery) ? fromQuery : "all";

    if (
      overflowTags &&
      toggleTagsButton &&
      initialFilter !== "all" &&
      !Array.from(overflowTags.querySelectorAll(".tag-filter")).every(
        (button) => button.dataset.filter !== initialFilter,
      )
    ) {
      overflowTags.classList.remove("hidden");
      overflowTags.classList.add("flex");
      toggleTagsButton.setAttribute("aria-expanded", "true");
      toggleTagsButton.textContent = "Less tags";
    }

    applyFilter(initialFilter);

    filters.forEach((button) => {
      button.addEventListener("click", () => {
        const filter = button.dataset.filter || "all";
        applyFilter(filter);
      });
    });

    if (overflowTags && toggleTagsButton) {
      toggleTagsButton.addEventListener("click", () => {
        const expanded = toggleTagsButton.getAttribute("aria-expanded") === "true";
        if (expanded) {
          overflowTags.classList.add("hidden");
          overflowTags.classList.remove("flex");
          toggleTagsButton.setAttribute("aria-expanded", "false");
          toggleTagsButton.textContent = "More tags";
          return;
        }

        overflowTags.classList.remove("hidden");
        overflowTags.classList.add("flex");
        toggleTagsButton.setAttribute("aria-expanded", "true");
        toggleTagsButton.textContent = "Less tags";
      });
    }
  </script>
</BaseLayout>
