---
import BaseLayout from "../../../../../layouts/BaseLayout.astro";
import ArticleListItem from "../../../../../components/ArticleListItem.astro";
import PaginationNav from "../../../../../components/PaginationNav.astro";
import TagFilterBar from "../../../../../components/TagFilterBar.astro";
import {
  filterArticlesByTag,
  getAllTagsByFrequency,
  getPaginatedArticles,
  getVisibleArticles,
  toTagSlug,
} from "../../../../../lib/articles";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const allArticles = await getVisibleArticles();
  const allTags = getAllTagsByFrequency(allArticles);

  return allTags.flatMap((tag) => {
    const tagSlug = toTagSlug(tag);
    const { items } = filterArticlesByTag(allArticles, tagSlug);
    const { totalPages } = getPaginatedArticles(items, 1);

    return Array.from({ length: Math.max(0, totalPages - 1) }, (_, index) => {
      const page = index + 2;
      const paginated = getPaginatedArticles(items, page);

      return {
        params: {
          tag: tagSlug,
          page: String(page),
        },
        props: {
          allTags,
          tagSlug,
          tagLabel: tag,
          items: paginated.items,
          currentPage: paginated.currentPage,
          totalPages: paginated.totalPages,
        },
      };
    });
  });
}

interface Props {
  allTags: string[];
  tagSlug: string;
  tagLabel: string;
  items: CollectionEntry<"articles">[];
  currentPage: number;
  totalPages: number;
}

const { allTags, tagSlug, tagLabel, items, currentPage, totalPages } = Astro.props;
---

<BaseLayout
  title={`Articles - ${tagLabel} - Page ${currentPage} | Pedro Pinto`}
  description={`Articles tagged ${tagLabel} on engineering, leadership, and software development.`}
>
  <section class="max-w-3xl">
    <h1 class="font-heading text-4xl text-[var(--color-text)]">Articles</h1>
    <p class="mt-3 text-[var(--color-muted)]">Filtered by tag: {tagLabel}</p>
  </section>

  <TagFilterBar tags={allTags} activeTagSlug={tagSlug} />

  <section class="mt-8 grid gap-4">
    {items.map((article) => <ArticleListItem article={article} />)}
  </section>

  <PaginationNav currentPage={currentPage} totalPages={totalPages} tagSlug={tagSlug} />
</BaseLayout>
